
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 7.2.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>Glide 资源重用错误 - Cannot draw a recycled Bitmap - shumxin's blog</title>

  
    <meta name="description" content="问题描述背景最近看了我司某产品的 Bugly 上的崩溃分析统计，注意到 Canvas: trying to use a recycled bitmap android.graphics.Bitmap@e9a8c74 异常有点醒目。  问题调用栈12345678910111213141516171819202122232425java.lang.RuntimeException: Canvas: t">
<meta property="og:type" content="article">
<meta property="og:title" content="Glide 资源重用错误 - Cannot draw a recycled Bitmap">
<meta property="og:url" content="https://shumxin.github.io/2021/06/26/glide-resource-re-use-error/index.html">
<meta property="og:site_name" content="shumxin&#39;s blog">
<meta property="og:description" content="问题描述背景最近看了我司某产品的 Bugly 上的崩溃分析统计，注意到 Canvas: trying to use a recycled bitmap android.graphics.Bitmap@e9a8c74 异常有点醒目。  问题调用栈12345678910111213141516171819202122232425java.lang.RuntimeException: Canvas: t">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://shumxin.github.io/images/post/210627_bugly_crash_report.png">
<meta property="article:published_time" content="2021-06-26T21:27:28.000Z">
<meta property="article:modified_time" content="2024-05-18T12:42:39.069Z">
<meta property="article:author" content="shumxin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://shumxin.github.io/images/post/210627_bugly_crash_report.png">
  
  
  
  

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  

  

  
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="undefined" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">shumxin's blog</div><div class="sub cap">Quietly Brilliant</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="/2024/04/05/build-aosp-in-mackbook-pro-m3-max/"><span class="title">MacBook Pro M3 Max 上编译 AOSP</span></a><a class="item title" href="/2024/05/01/before-android-boot-process/"><span class="title">Android 系统启动前</span></a><a class="item title" href="/2024/05/12/gain-root-privilege-by-arm-mali-gpu-driver-vulnerability/"><span class="title">利用 Arm Mali GPU 驱动漏洞获取 root 权限</span></a><a class="item title" href="/2024/04/30/get-started-with-ASfP/"><span class="title">使用 ASfP 阅读和调试 AOSP</span></a><a class="item title" href="/2021/06/26/glide-resource-re-use-error/"><span class="title">Glide 资源重用错误 - Cannot draw a recycled Bitmap</span></a><a class="item title" href="/2021/08/13/opening-aosp-native-code-with-clion/"><span class="title">使用 CLion 查看 AOSP Native 代码</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/android/">android</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2021-06-26T21:27:28.000Z">2021-06-27</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-05-18T12:42:39.069Z">2024-05-18</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>Glide 资源重用错误 - Cannot draw a recycled Bitmap</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近看了我司某产品的 Bugly 上的崩溃分析统计，注意到 <code>Canvas: trying to use a recycled bitmap android.graphics.Bitmap@e9a8c74</code> 异常有点醒目。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/../images/post/210627_bugly_crash_report.png" alt="bugly_crash_report"></p>
<h3 id="问题调用栈"><a href="#问题调用栈" class="headerlink" title="问题调用栈"></a>问题调用栈</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: Canvas: trying to use a recycled bitmap android.graphics.Bitmap<span class="meta">@de87ba3</span></span><br><span class="line">    at android.graphics.BaseCanvas.throwIfCannotDraw(BaseCanvas.java:<span class="number">66</span>)</span><br><span class="line">    at android.graphics.MiuiCanvas.throwIfCannotDraw(MiuiCanvas.java:<span class="number">329</span>)</span><br><span class="line">    at android.graphics.RecordingCanvas.throwIfCannotDraw(RecordingCanvas.java:<span class="number">277</span>)</span><br><span class="line">    at android.graphics.BaseRecordingCanvas.drawBitmap(BaseRecordingCanvas.java:<span class="number">88</span>)</span><br><span class="line">    at app.abk.draw(SourceFile:<span class="number">101</span>)</span><br><span class="line">    at android.widget.ImageView.onDraw(ImageView.java:<span class="number">1436</span>)</span><br><span class="line">    at android.view.View.draw(View.java:<span class="number">22489</span>)</span><br><span class="line">    at android.view.View.updateDisplayListIfDirty(View.java:<span class="number">21357</span>)</span><br><span class="line">    at android.view.View.draw(View.java:<span class="number">22217</span>)</span><br><span class="line">    at android.view.ViewGroup.drawChild(ViewGroup.java:<span class="number">4540</span>)</span><br><span class="line">    at android.view.ViewGroup.dispatchDraw(ViewGroup.java:<span class="number">4299</span>)</span><br><span class="line">    at android.view.View.updateDisplayListIfDirty(View.java:<span class="number">21348</span>)</span><br><span class="line">    at android.view.View.draw(View.java:<span class="number">22217</span>)</span><br><span class="line">    at android.view.ViewGroup.drawChild(ViewGroup.java:<span class="number">4540</span>)</span><br><span class="line">    at android.view.ViewGroup.dispatchDraw(ViewGroup.java:<span class="number">4299</span>)</span><br><span class="line">    at android.view.View.draw(View.java:<span class="number">22492</span>)</span><br><span class="line">    at android.view.View.updateDisplayListIfDirty(View.java:<span class="number">21357</span>)</span><br><span class="line">    at android.view.View.draw(View.java:<span class="number">22217</span>)</span><br><span class="line">    at android.view.ViewGroup.drawChild(ViewGroup.java:<span class="number">4540</span>)</span><br><span class="line">    at android.view.ViewGroup.dispatchDraw(ViewGroup.java:<span class="number">4299</span>)</span><br><span class="line">    at android.widget.AbsListView.dispatchDraw(AbsListView.java:<span class="number">2705</span>)</span><br><span class="line">    at android.view.View.draw(View.java:<span class="number">22492</span>)</span><br><span class="line">    at android.widget.AbsListView.draw(AbsListView.java:<span class="number">4448</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>查看对应版本的 mapping 文件确认 <code>app.abk</code> 对应 <code>com.bumptech.glide.load.resource.bitmap.GlideBitmapDrawable</code></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><h3 id="提取主要信息"><a href="#提取主要信息" class="headerlink" title="提取主要信息"></a>提取主要信息</h3><p>正常来说根据异常信息的堆栈很容易定位到相关业务代码的出错位置，而该堆栈信息乍一看有点懵</p>
<p>首先对于 <code>Canvas: trying to use a recycled bitmap android.graphics.Bitmap@xxxxxxxx；</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">throwIfCannotDraw</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bitmap.isRecycled()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Canvas: trying to use a recycled bitmap &quot;</span> + bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!bitmap.isPremultiplied() &amp;&amp; bitmap.getConfig() == Bitmap.Config.ARGB_8888 &amp;&amp;</span><br><span class="line">            bitmap.hasAlpha()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Canvas: trying to use a non-premultiplied bitmap &quot;</span></span><br><span class="line">                + bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">    throwIfHwBitmapInSwMode(bitmap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因是 <code>ImageView#onDraw</code> 的时候尝试使用已回收的 <code>bitmap</code> 进而造成该崩溃。</p>
<p>知道上述原因对问题的分析无实质性帮助，根据 <code>com.bumptech.glide.load.resource.bitmap.GlideBitmapDrawable</code> 信息首先可以确认是用到 Glide 加载图片相关的业务代码，堆栈信息中有 <code>AbsListView</code> 可以确认和其相关子类的控件有关，如 <code>ListView</code> 和 <code>GridView</code>。结合这两点能很快确认和某一块的业务代码相关。</p>
<h3 id="检索类似异常"><a href="#检索类似异常" class="headerlink" title="检索类似异常"></a>检索类似异常</h3><p>既然和 Glide 相关，所以直接去 github 上 <a target="_blank" rel="noopener" href="https://github.com/bumptech/glide">glide</a> 的官方项目检索相关 <a target="_blank" rel="noopener" href="https://github.com/bumptech/glide/issues?q=Canvas:+trying+to+use+a+recycled+bitmap+">issue</a>，发现该问题的反馈还挺多，查看了几个类似问题后最终指向了官方关于常见错误一个说明文档 <a target="_blank" rel="noopener" href="http://bumptech.github.io/glide/doc/resourcereuse.html#common-errors">common-errors</a></p>
<p>其中关于 <code>Cannot draw a recycled Bitmap</code> 官方的说明如下</p>
<blockquote>
<p>Glide 的 <code>BitmapPool</code> 是固定大小的。当 <code>Bitmap</code> 从中被踢出而没有被重用时，Glide 将会调用 <code>recycle()</code>。如果应用在向 Glide 指出可以安全地回收之后 “不经意间” 继续持有 <code>Bitmap</code>，则应用可能尝试绘制这个 <code>Bitmap</code>，进而在 <code>onDraw</code> 方法中造成崩溃。<br>一种可能的情况是，一个目标被用于两个 <code>ImageView</code>，而其中一个在 <code>Bitmap</code> 被放到 <code>BitmapPool</code> 中后仍然试图访问被回收后的 <code>Bitmap</code>。基于以下因素，要复现这种复用错误可能很困难：1）<code>Bitmap</code> 何时被放入池中，2）<code>Bitmap</code> 何时被回收，3）何种尺寸的 <code>BitmapPool</code> 和内存缓存会导致 <code>Bitmap</code> 的回收。可以在你的 <code>GlideModule</code>中加入下面的代码片段，以使这个问题更容易复现：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applyOptions</span><span class="params">(Context context, GlideBuilder builder)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bitmapPoolSizeBytes</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">0</span>; <span class="comment">// 0mb</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">memoryCacheSizeBytes</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">0</span>; <span class="comment">// 0mb</span></span><br><span class="line">    builder.setMemoryCache(<span class="keyword">new</span> <span class="title class_">LruResourceCache</span>(memoryCacheSizeBytes));</span><br><span class="line">    builder.setBitmapPool(<span class="keyword">new</span> <span class="title class_">LruBitmapPool</span>(bitmapPoolSizeBytes));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面的代码确保没有内存缓存，且 <code>BitmapPool</code> 的尺寸为 0；因此 <code>Bitmap</code> 如果恰好没有被使用，它将立刻被回收。这是为了调试目的让它更快出现。</p>
</blockquote>
<h3 id="尝试复现"><a href="#尝试复现" class="headerlink" title="尝试复现"></a>尝试复现</h3><p>结合上述说明我们可以尝试在项目代码里面对怀疑的地方进行相关日志添加再模拟场景尝试复现。实际的业务代码场景入手其实可以先定位大致位置，尝试触发大量图片加载触发 Glide <code>BitmapPool</code> 进行资源回收后来进行场景复现。这里我就简单通过 <a target="_blank" rel="noopener" href="https://github.com/shumxin/Drimo/tree/main/glideresreuseerror">Demo</a> 来复现该崩溃。</p>
<p>首先按照官网说明配置 <code>MemoryCache</code> 和 <code>BitmapPool</code> 大小为 0</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlideModule</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyAppGlideModule</span> : <span class="type">AppGlideModule</span>() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">applyOptions</span><span class="params">(context: <span class="type">Context</span>, builder: <span class="type">GlideBuilder</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> bitmapPoolSizeBytes = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">0</span> <span class="comment">// 0mb</span></span><br><span class="line">        <span class="keyword">val</span> memoryCacheSizeBytes = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">0</span> <span class="comment">// 0mb</span></span><br><span class="line">        builder.setMemoryCache(LruResourceCache(memoryCacheSizeBytes.toLong()))</span><br><span class="line">        builder.setBitmapPool(LruBitmapPool(bitmapPoolSizeBytes.toLong()))</span><br><span class="line">        builder.setLogLevel(Log.VERBOSE)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isManifestParsingEnabled</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的一点是:</p>
<blockquote>
<p>如果你在 Kotlin 编写的类里使用 Glide 注解，你需要引入一个 kapt 依赖，以代替常规的 <code>annotationProcessor</code> 依赖。<a target="_blank" rel="noopener" href="https://muyangmin.github.io/glide-docs-cn/doc/download-setup.html#kotlin">见下载和设置</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/shumxin/Drimo/tree/main/glideresreuseerror">Demo</a> 尝试复现首次实现如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    Glide.with(holder.imageView.context).load(dataSet[position]).into(holder.imageView)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现一直无法复现相应崩溃场景，虽然在此之前已修复对应我司产品项目中的崩溃问题。看到这篇 <a target="_blank" rel="noopener" href="https://blog.csdn.net/Conan9715/article/details/117914506">Blog</a> 后才发现当时虽然解决了问题，但是深挖的还不够。</p>
<p>如该博主所说，当使用 <code>into(imageView)</code> 的方式加载图片，不会抛出异常。<code>into(imageView)</code> 的方式后面会<code>setResourceInternal(null)</code>，最终会调用到 <code>ImageView.setImageDrawable(null)</code>。这样在 <code>ImageView onDraw</code> 时判断 <code>mDrawable == null</code> 时直接返回了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDrawable == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// couldn&#x27;t resolve the URI</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当使用 <code>into(Target)</code> 的方式则可能会导致抛出该异常，看了下我们的项目代码确实最终封装用到的是 <code>SimpleTarget</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    Glide.with(holder.imageView.context).load(dataSet[position])</span><br><span class="line">        .into(<span class="keyword">object</span> : CustomViewTarget&lt;View, Drawable&gt;(holder.imageView) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLoadFailed</span><span class="params">(errorDrawable: <span class="type">Drawable</span>?)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceReady</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                resource: <span class="type">Drawable</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                transition: <span class="type">Transition</span>&lt;<span class="type">in</span> <span class="type">Drawable</span>&gt;?</span></span></span><br><span class="line"><span class="params"><span class="function">            )</span></span> &#123;</span><br><span class="line">                holder.imageView.setImageDrawable(resource)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceCleared</span><span class="params">(placeholder: <span class="type">Drawable</span>?)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>into(target)</code> 的方式复现了该崩溃</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">io.github.shumxin.glideresreuseerror E/AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line">    Process: io.github.shumxin.glideresreuseerror, PID: <span class="number">23165</span></span><br><span class="line">    java.lang.RuntimeException: Canvas: trying to use a recycled bitmap android.graphics.Bitmap@3b85e5e</span><br><span class="line">        at android.graphics.BaseCanvas.throwIfCannotDraw(BaseCanvas.java:<span class="number">66</span>)</span><br><span class="line">        at android.graphics.RecordingCanvas.throwIfCannotDraw(RecordingCanvas.java:<span class="number">277</span>)</span><br><span class="line">        at android.graphics.BaseRecordingCanvas.drawBitmap(BaseRecordingCanvas.java:<span class="number">88</span>)</span><br><span class="line">        at android.graphics.drawable.BitmapDrawable.draw(BitmapDrawable.java:<span class="number">548</span>)</span><br><span class="line">        at android.widget.ImageView.onDraw(ImageView.java:<span class="number">1436</span>)</span><br><span class="line">        at android.view.View.draw(View.java:<span class="number">22350</span>)</span><br><span class="line">        at android.view.View.updateDisplayListIfDirty(View.java:<span class="number">21226</span>)</span><br><span class="line">        at android.view.View.draw(View.java:<span class="number">22081</span>)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>这里 <code>ImageView</code> 在 <code>onDraw</code> 阶段用到的 <code>mDrawable</code> 实际是 <code>BitmapDrawable</code>，其持有了对应的 <code>Bitmap</code> 对象，该 <code>Bitmap</code> 对象在 Glide 的 <code>LruBitmapPool#put</code> 方法中当不满足缓存条件时则会调用 <code>bitmap.recycle()</code> 进行回收。<code>RecyclerView</code> 滑动时当出现 <code>ViewHolder</code> 复用时，新的图片资源还未获取到时，该 <code>ViewHolder</code> 中的 <code>ImageView</code> 用之前请求的图片资源进行绘制时，对应该图片资源的 <code>mDrawable</code> 中的 <code>Bitmap</code> 已经被回收，遂会抛出该异常。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>结合原因分析，最初我在工程项目里面的实现方案则是通过对崩溃的地方的自定义 ImageView，并对其 <code>onDraw()</code> 方法进行重写。判断如果当前持有的 <code>mDrawable</code> 是 <code>BitmapDrawable</code>，当其持有的 <code>bitmap.isRecycled</code>，则不触发最终的绘制操作。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (drawable <span class="keyword">is</span> BitmapDrawable) &#123;</span><br><span class="line">        (drawable <span class="keyword">as</span> BitmapDrawable).bitmap?.let &#123;</span><br><span class="line">            <span class="keyword">if</span> (it.isRecycled) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述方式可以解决该问题，但是其中的一个缺陷是需要知道哪些类型的 <code>drawable</code> 会持有 <code>bitmap</code>，比如 3.x 版本的 Glide 有 <code>GlideBitmapDrawable</code>，其内部也持有 <code>bitmap</code>，对于上述的处理就需要再增加一个分支处理。</p>
<p>那有没有更合适的方式来处理该问题呢，对于实现 CustomViewTarget 中 <code>onLoadFailed(@Nullable Drawable errorDrawable)、onResourceReady(@NonNull R resource, @Nullable Transition&lt;? super R&gt; transition)、onResourceCleared(@Nullable Drawable placeholder)</code> 三个方法时，其中 <code>onResourceCleared</code> 很容易被忽略。</p>
<p>关于 <code>onResourceCleared(@Nullable Drawable placeholder)</code> 的说明如下</p>
<blockquote>
<p>A required callback invoked when the resource is no longer valid and must be freed. You must ensure that any current Drawable received in onResourceReady(Object, Transition) is no longer used before redrawing the container (usually a View) or changing its visibility. Not doing so will result in crashes in your app.  </p>
</blockquote>
<p><code>onResourceCleared(@Nullable Drawable placeholder)</code> 是由 <code>onLoadCleared(@Nullable Drawable placeholder)</code> 调用</p>
<p>关于 <code>onLoadCleared(@Nullable Drawable placeholder)</code> 的说明如下</p>
<blockquote>
<p>A mandatory lifecycle callback that is called when a load is cancelled and its resources are freed.<br>You must ensure that any current Drawable received in onResourceReady(Object, Transition) is no longer used before redrawing the container (usually a View) or changing its visibility.  </p>
</blockquote>
<p>再看下官方文档相关的说明 <a target="_blank" rel="noopener" href="http://bumptech.github.io/glide/doc/resourcereuse.html#loading-a-resource-into-a-target-clearing-or-reusing-the-target-and-continuing-to-reference-the-resource">链接</a></p>
<blockquote>
<p><strong>往Target中加载资源，清除或重用Target，并继续引用该资源</strong></p>
<p>最简单的比较这个错误的办法是确保所有对资源的引用都在 <code>onLoadCleared()</code> 调用时置空。通常，加载一个 <code>Bitmap</code> 然后对 <code>Target</code> 解引用，并且不要再次调用 <code>into()</code> 或 <code>clear()</code>，这样是安全的。然而，加载了一个 <code>Bitmap</code>，清除这个 <code>Target</code>，并在之后继续持有 <code>Bitmap</code> 引用是不安全的。类似地，加载资源到一个 <code>View</code> 上然后从 <code>View</code> 中获取这个资源 (通过 <code>getImageDrawable()</code> 或任何其他手段)，并在其他某个地方继续引用它，也是不安全的。</p>
</blockquote>
<p>当 Glide 回调 <code>onResourceCleared</code> 后即准备将相关的 <code>bitmap</code> 进行回收，所以我们只需要在 <code>onResourceCleared</code> 的时候主动 <code>setImageDrawable(null)</code> 不再持有接下来将被回收的 <code>Bitmap</code> 即可解决问题</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResourceCleared</span><span class="params">(placeholder: <span class="type">Drawable</span>?)</span></span> &#123;</span><br><span class="line">    holder.imageView.setImageDrawable(<span class="literal">null</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>[1] <a target="_blank" rel="noopener" href="http://bumptech.github.io/glide/doc/resourcereuse.html">Glide Resource Reuse</a></li>
<li>[2] <a target="_blank" rel="noopener" href="https://blog.csdn.net/Conan9715/article/details/117914506">Glide 导致的 RuntimeException: Canvas: trying to use a recycled bitmap android.graphics.Bitmap</a></li>
</ul>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2021/08/13/opening-aosp-native-code-with-clion/">使用 CLion 查看 AOSP Native 代码</a></div><div class="item" id="next"></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">shumxin</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-text">问题描述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-text">问题调用栈</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">问题分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E4%B8%BB%E8%A6%81%E4%BF%A1%E6%81%AF"><span class="toc-text">提取主要信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E7%B1%BB%E4%BC%BC%E5%BC%82%E5%B8%B8"><span class="toc-text">检索类似异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E5%A4%8D%E7%8E%B0"><span class="toc-text">尝试复现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-text">原因分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
